.kaniko:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"credsStore\":\"ecr-login\"}" > /kaniko/.docker/config.json
    - eval TEMP_VARIABLE=\"\$$KANIKO_IMAGE_EXISTS\" && echo $TEMP_VARIABLE && if [ -z $TEMP_VARIABLE ] ;
      then
        /kaniko/executor
          --context "${CI_PROJECT_DIR}"
          --dockerfile "${CI_PROJECT_DIR}/${KANIKO_DOCKER_FILE}"
          --destination "${KANIKO_IMAGE}" ;
      else
        echo "Not going to build the image ${KANIKO_IMAGE} as it exists in the repo!" ;
      fi
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "false"'
      when: never
    - when: on_success
